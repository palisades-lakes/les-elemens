package palisades.lakes.elements.java.test.numbers;

import org.apache.commons.rng.UniformRandomProvider;
import org.apache.commons.rng.simple.RandomSource;
import org.junit.After;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;

import palisades.lakes.elements.java.numbers.Doubles;
import palisades.lakes.elements.java.numbers.PRNG;

//----------------------------------------------------------------
/** Tests for doubles.
 * 
 * @see <a href="http://perso.ens-lyon.fr/jean-michel.muller/Handbook.html">
 * Muller et al, "Handbook of floating-point arithmetic".</a>
 * 
 * @see <a href="http://www.ma.man.ac.uk/~higham/asna/">
 * Higham, "Accuracy and stability of numerical algorithms".</a>
 * 
 * 
 * @author palisades dot lakes at gmail dot com
 * @since 2017-05-03
 * @version 2017-05-03
 */

public final class DoublesTest {

  private final static int[] SEED = 
  { -1124830406, 859864448, 2076701614, 1215342899, 2001802975,
    589422490, -1222475370, -766797166, 183780857, 1734380763,
    1959363853, 1036296815, 926073233, -1670442746, -1916968694,
    746865713, -1227292582, -448730413, 1524008140, -19925360,
    617372260, -2080022124, -176077164, 515797050, 1644986547,
    788850366, 1646717573, 326230976, 214654117, 470113136,
    -674013276, 70282814, 1086284531, -910898922, -626633905,
    -901012760, 6878248, -532279221, 1325586859, 997630043,
    -697429266, -1631497160, 529965954, -1513535452,
    -1680937987, -715928424, 92517009, 761932139, -457595082,
    -1338094677, 296015890, 157971779, 1221911931, 1546325550,
    -747295107, -934828779, 1557606952, -205455961, -387029542,
    188486908, -1299387424, -1604718258, -1937197938,
    -139172041, -210623013, 1927923610, -1898145905, 1571734069,
    305028499, 510855128, -937838374, -1450953967, -2020400977,
    -883547511, 769065005, -1620511798, -1613550328, 2073310122,
    427749431, 347084237, -1684231934, -1914989401, 154689114,
    507867693, -597712211, -465132885, 1301280750, -818284476,
    1279511649, 1807859631, -1085724316, -1008636168,
    -1837835334, -686842099, 1615942062, 422814877, 1708626788,
    481962492, -1087045454, -509003031, -245962480, 144548834,
    1871586044, -1669859253, 1724835723, -347317689,
    -2125260268, 1921598667, 1064940055, 1454532442,
    -1674686470, 240313404, 1254571959, 2075104537, -1365623945,
    -403166830, -952932473, -1769781834, 622268413, 1715683,
    -73583691, -406538351, -1494573273, -537456065, 2118235612,
    1645730081, -921763112, -615550679, 4133602, 1032135544,
    -1331341320, -1803391322, 1215745532, -141173637,
    1575929078, 2113386898, -2059280981, 855289108, 1775050517,
    1698117591, -1413684188, -2025763689, 1626275317,
    -1158000390, 51653497, -1764787988, 359231088, -1950778674,
    1775001920, -969464015, -1325655686, -296014150, 779645762,
    106071514, 1006896497, -931420137, -2077604216, -365339887,
    -214949558, -1363898151, -1037100399, -1163841875, 24479437,
    -299339677, 839577560, 1778559546, 1572045513, -143339601,
    -1649475255, 1610040099, 457221973, 1674640003, 1043230964,
    -42245158, 1266214800, 723446271, 1504624720, 1072379611,
    -386508521, 470047171, 1008775207, -1685835554, -1143308793,
    -1289563308, 165913281, -691858951, -604186747, 581418324,
    -1830679834, 2051958348, 948468016, -513559144, -1217397964,
    1250849412, 358688156, 810538786, 1439002586, 1242530753,
    2091534207, -922698219, 362393705, 956917213, 1480777744,
    -1804119686, 573655008, -1771769711, 2107964259, 1629680908,
    -66081139, -598963542, -541475614, -1992436904, 907803429,
    -1627454078, -1802448826, -2136265157, 1497950328,
    1619603401, 207478849, -929569717, 1930782614, -1048551257,
    -1970738728, 902000775, 260665702, -2017288222, 1933447452,
    1121222306, 1571718431, -740599872, 1038008195, -934779783,
    -1827340611, 1178880740, -1228521983, -1220732190,
    -1798852791, -2015938442, -1331116443, 845650830,
    1497051114, -981322647, -8697458, 157137875, 897127389,
    1933863200, 1049818609, -1916395799, 143849705, 1808753935,
    1064579933, 1465374797, 1312453075, 1135817114, 296129430,
    1189596574, -1665764132, 161031339, -118378906, 268276890,
    -880993397, -438696714, 849074466, 2078740891, 1976662577,
    282351885, 1532071561, 245020753, -1816812499, 1895895535,
    -489469320, -2040371321, -649851857, 462681406, 1935838990,
    -1752079024, 495020933, 1127906449, 1973396045, -48619361,
    1673127076, -683946422, -104201298, 504628502, -161194309,
    2118138683, 1889358339, 1383198823, 808202933, 1241526968,
    655591020, 1325211930, 209089439, -2015469604, -1901454721,
    919050574, -989002716, -1048125964, 1533952132, -845419873,
    -1530053057, -2028819095, 1753832297, -1715766552,
    532255018, -1108447775, 789979786, -42719577, 1553637519,
    -812404612, -574521749, 1549402180, -1625111889, 224265902,
    -608794390, -694638729, -1988776268, -2052163214,
    -2142084079, -1133674814, -1974047698, -1139893859,
    -1117486994, -1782828592, 898931739, 1480358682, -384699109,
    -1229724451, 650792363, 954067035, -267336691, 1402777860,
    -153667491, -1214818968, 885458133, 1595808607, -706587854,
    771076600, 409038741, 887490939, -881369802, -1659859330,
    1371908509, -1910495068, -1179448339, 1570309386, 490737201,
    1872835061, 1030649507, 517746899, -433237002, -512523294,
    513486749, -1192079510, 1966948465, 644608501, -1731471103,
    1220731570, -1053584766, 1380641730, 1598888608,
    -1840248955, -1771879090, -198896149, -1031795586,
    2070975268, 1806105240, -1182295151, -1548813755,
    -1158487052, 602584893, 660020988, -390883676, 1997795394,
    -1060627442, -555364607, -232104839, -88013970, -443905844,
    2056606866, -265303694, -1277686867, -279113844, 932599857,
    507546604, 255597611, -2062277139, 1549656932, -918152984,
    -1457186724, 1203894242, 1780088244, -342490887, -661366800,
    1905154225, 278730486, -179149869, -1245084802, -309358410,
    -453079376, -593909407, 227726924, 422430210, -1475500441,
    -1809185354, -1384341829, 889797440, -1224505552, 640950833,
    1419304488, -1967769341, 1928916162, -1053663703, -99406787,
    214853621, 1048811785, -1418298173, -1282702049,
    -1006930415, 1592452294, 1303336192, -88544490, -977348413,
    -595806168, -647737164, 1051361313, 1187040270, 705468252,
    1515160004, -249860366, 450831047, -21432376, -1555060704,
    -58111103, -829288651, -996247936, -724696669, -1580170656,
    -454446074, -2008457766, 1776792137, 521835011, -1074083882,
    1533659101, -1827147169, -122535713, -2061045209,
    2065586803, 104043799, -359494781, 112986365, -1791977209,
    431896965, -663980817, 1953394894, 766995024, 1108553727,
    1533684623, 99763885, -1259404801, 1270861723, -743230596,
    -439848486, -469315664, 1120428885, -1069990975, -183836732,
    1490113437, -1529574, -364386171, 202312516, -334340210,
    -358220275, -476193778, 1825274639, 1054802245, -984787716,
    1527871401, -1147534598, 57538993, 1252286006, 1115431581,
    -1134546685, -1715800938, 1354877012, -976422010,
    -866251129, -777480858, -736446790, -1153709058, -322140871,
    -1656145494, -1864625589, -557232818, 1878916354,
    -2047163132, 924284402, 120345682, -424821673, -1413270866,
    -217910188, 1724241814, -584082417, 20686413, 932039477,
    1869048854, -289361852, -1293252624, 1748599904, 823794022,
    -1981349571, -1954279307, -1149222145, 365946088,
    -1811749182, -2023782478, 2032334710, 797879860, 1088785906,
    -1145309981, 1456409484, -1061575597, -207859683, -4242796,
    410166486, 1008276075, 303002848, -1013574704, 635551599,
    -1265101410, -2046342099, -2105318571, -1761103108,
    -1074682306, -560180900, -2070470075, -139270706,
    -952620889, 1891890681, 1924645784, -991148638, -1159977476,
    -2127844497, -1404838806, 184117525, 1820669571, -711276172,
    -795577366, -2107949318, 1935432536, -2126690229,
    1094424905, -122856672, 1216059980, -1313844292, 250555167,
    -295635249, -219488933, -1869747074, -261280658,
    -1642661381, -969354800, 1208826496, -408012301, -637316956,
    -1877962186, -290312084, 1522017230, -876191043,
    -1378554344, 1090420097, -1354632705, -827764636,
    -1243490593, 1553712630, 269193108, 614497930, -736935975,
    1867028135, 1316511853, 1090977083, 125270519, -1908609088,
    -1682057251, -1969898652, -585519577, 724753556,
    -2117138176, 46078441, -1614872009, 2072651409, 1367068220,
    318912468, -721263428, -1581492560, 1760360349, -489465682,
    1864652052, 816188715, -1462204035, 98642290, -636662621,
    277141838, -2020109324, 44596300, 817910484, -1563962318,
    -887670586, -281374413, -1070770121, -1662871745, 275367784,
    -1972133118, 2063744076, 966936223, 178422340, -1507861840,
    1668850693, -1298348704, 720195118, -141429024, -758807184,
    1589377671, 643391856, 646864328, 1121025789, -1128277782,
    -1137386500, 1401439127, -690897292, 727021549, -1950462393,
    1973401257, -712306529, 1533370816, -66402313, -36762286,
    -144562674, 648338947, -1895915177, -1218837941, 1542237252,
    74706974, -132874269, -347842556, -1653626517, 658642261,
    3196689, 1162451600, -2062615841, -681571792, 833459549,
    -171275589, -427820290, -1944204513, -1322131410,
    -1826128176, -1519110970, 1091004068, -823562589, 444644956,
    -1882003649, -736736808, -887750900, -1353093039,
    2094577483, 827806561, -1430064795, 689676399, 1859499545,
    1683664469, -1929038574, 1937489486, 1124828502, 677203173,
    1091314245, 2087609094, 332645491, -994692335, -981399242,
    -1185845129, 1045299792, -653296649, 1038030667,
    -1589813960, 14722410, 35429583, 423055221, -1746818064,
    -348389428, -902756626, 421391615, -1961438589, 501012188,
    1728001560, -1726437809, -1304581348, -1556442957,
    1277746531, -937281018, 342046624, -453055542, -418141802,
    -42139065, 1751265395, 304373727, 108622849, -2139448863,
    2092075833, -1508434894, 1987997458, 621375460, 461394345,
    -1477090603, 1375856079, -283926822, 443528802, 2071039952,
    -340001065, 954431883, 1281681698, 1391018891, 181654647,
    755421762, 385364391, 328311854, -164594109, -714128242,
    -367189785, -699746176, 2092688961, 918886052, -1316780933,
    -1496775322, -889602559, 1754544236, -1450246775,
    1765068253, 784487397, 1481229224, -924961268, -1017050403,
    755648367, 368860049, -808368935, -716721669, -223814355,
    438421819, 1973066799, 524096266, 699541606, -1212542161,
    -1194120995, 582191897, -1168817276, -1572763644,
    -544155988, 1503251107, -1986734243, -165819801,
    -1203267672, -812677219, 355741878, -1806713427, 2133246991,
    -2019634449, -726014187, -810302663, 971381632, 580546848,
    2010974742, 1569108503, 520944133, 1118636674, 923410506,
    -313227913, -368752105, 408208418, -234930348, 111015852,
    609624575, 935410066, 1428462669, -1106886593, -1475897469,
    -1687823272, -729463637, -555512114, -287687533, 827397001,
    189094114, -1791164468, 833858142, -1506876151, 1591102388,
    133170991, -1406585877, -1703575911, -1638272112,
    -1386176406, 115454846, 1895521692, 1272715674, -1844810700,
    401550539, 1528480514, 619479626, -2000295374, 859138717,
    1876538915, 1302993612, 222912086, 914681728, -2060501263,
    -1014849422, -1110690231, 117653430, -1585407090, 975213238,
    1934577919, -1608357245, 126800167, 1428025007, -496248792,
    755761485, -1660457538, -1339406240, -691152813,
    -1809839449, 1831553870, 881710868, 1281868171, -1121468584,
    775558225, -598573232, 1890474100, 545039843, -637342872,
    -1761495908, 330626036, 1413421054, -1631307282, 2123845195,
    -791504663, 1417160848, -1539762211, -149207792, 752544495,
    -212755812, 540365588, 1546952240, -1169742565, 267913771,
    -1825759382, -821598157, 898246269, 1374435957, 521918910,
    -842559223, -1142708643, -1732582836, 2001004297,
    -823447461, 477912137, -1887407930, -1499917036,
    -1341246521, 1146350639, -1762190116, 1215719638,
    -995262465, 12069160, 781601972, 1602919194, 1677089267,
    -1881147011, 2096662378, 1577049316, -1833562208, 167150468,
    -136603380, -1572628287, 2123986458, 549047807, -790124843,
    743536989, -469753345, 435111371, -618748906, 2181114,
    -946521307, 1314845048, -1745805452, -1299905947,
    -737463840, -224875275, 216569448, 310913073, -2020318386,
    -978869535, -2047287899, -373322025, -1403289617,
    -1809060191, 1223077343, 123206367, -735725682, -483420347,
    -1116790054, -342691062, 1693300167, 1316107719, 367386506,
    256620560, 914710912, -1958511683, -1993890110, -1191395616,
    -301580883, -323978540, 1320546518, -176534490, 419964712,
    2146227366, 975492385, 619851438, 656166994, -849963241,
    1565858373, -2009670090, 1392635818, 1564587169, 761105298,
    -2087505763, 81843863, 187672006, 1854197013, 476404474,
    1932238778, 741598921, -1543440021, -609954202, -1449586606,
    936825783, -148166699, -1781768422, 1063094092, 1364289622,
    -1559383991, -1437640864, -1025903940, -16494648,
    -2091895579, 1838253, -884981516, -1998111851, 1975681894,
    -2006482166, -1809251180, 954092832, 919107514, 359032480,
    -349589940, 1488939585, -617599700, 27605289, 876146712,
    256879527, 890194112, -208423140, -1855764672, -1678766194,
    221527066, -1815001161, 598455410, 920991194, 1880954186,
    -1839643972, 245856621, 232692611, 1661711009, -8454917,
    -1243153039, 204394731, -891470832, 1042089949, 1291487440,
    589670071, 841696913, -1058164846, -1699373845, -368638397,
    916928297, -344565374, 1840828680, 98800960, 381339075,
    -2320577, -245398380, -1302044224, -400667779, 1254073379,
    -1837507342, 2047233455, 1974661968, -814060816,
    -1802530157, 1999298157, -1391742559, 1504304295,
    1798829475, 1603348715, 699361549, 926041991, -832402610,
    -124999766, 574517414, -1136176334, 2011261868, 223645749,
    1834964453, -394472420, 1149523851, -670001691, 375989753,
    -1547122598, 1676938868, -1027713680, 499319064, 1137951320,
    471125926, -949632251, 133123544, -1363945039, 1018289143,
    -403588037, -184523726, -2095116003, -374529680, 1311682223,
    -927311988, -1453730819, -1270649595, 152224390, -786939300,
    259526843, -63484475, 60224567, -2128262154, -701073169,
    1629065233, -1447941719, 1867343090, 1726082355, 524650631,
    -6757592, 579691659, 107729345, -127677445, -671067530,
    -794058322, 870394942, 1785581392, 1435897987, 897331819,
    624309458, 1018680351, -2059609212, 2053461916, -1243737579,
    -1426212644, -1030302164, 263866498, -1335972529,
    -1923307825, 1391197367, 1118625116, -1840329456,
    -375707752, -1012937916, 2116299284, 80845127, 420625501,
    704462613, 1072770779, 795318456, -1962548423, -1741593391,
    1872293203, -185374922, 812532099, -141156954, 784243181,
    -2091291910, -1938423246, 277815389, 950152791, 1751974347,
    -1779927607, 1109930519, 1437834782, -331132116, 1773607643,
    -479248286, -317960903, 262833259, -1145584920, 906238129,
    2012366894, 123433259, -1037459834, 1868620758, -78713713,
    2031274095, 1252050300, -1330994073, 902424238, 20470328,
    -441793914, 1573470361, -1500281459, -1077808703,
    1394744611, -98426110, 290224325, 1395208157, -351818324,
    -91314192, 1384879362, -1064112336, -2005947105,
    -1995540342, -471327003, 168667167, 53098184, 1240695389,
    588288033, 517064917, 1789411649, 372770584, 217174813,
    -1185236373, 1215740112, 1413168620, 1790321499, 1485093636,
    385401753, 1620851066, -1138447023, 1171835979, -1142329464,
    531112222, -951883686, -1911505350, -132600523, -1519550428,
    44228483, 283026284, 27737355, 541435230, -553454728,
    -47112112, 1788393958, 2074054718, -1132758033, -1967641398,
    650995034, 934912693, 1584389220, -1598182895, 1230293196,
    -755874043, -825240665, 317281988, -1025923790, -772263660,
    1906934469, -763355402, -1404140949, 1032273998, 557717241,
    -875231, 1162368241, -2028201782, -1479733942, -549936142,
    -940590254, -1431934270, -1866601907, -1947710405,
    -1335377970, 1293815539, 1397507829, -1788423281, 570681601,
    1931309393, -1543999432, 684129266, 105339116, 1295275972,
    -1076658843, 2060367777, 820793141, 605118505, -568721428,
    -1246301519, -1308047764, 230486237, 825419847, 1727057000,
    148186254, -85956957, 525045986, 1356562450, 1183902372,
    -877799891, 15178394, -1847140208, -68060764, -621282379,
    1850551259, 537157921, 1597968123, 2108715308, 1907849904,
    1558512390, -732770100, -1257211455, -528958144, 1971464541,
    2117553403, -1882106798, 377375692, 875036807, -272373125,
    -517404422, -92022508, 1161886604, -1663409221, 1713199210,
    -63709217, -1464766713, -797790843, -2022084347, 360014929,
    -1367383781, -13839916, -1793522406, -718148027, 2066132152,
    2131219661, 208929874, 2037101381, 181355564, -1898533640,
    -2042410043, 1077889316, 2003753325, -386949905, -929746294,
    545467559, -492200146, -138690630, -1959562595, 243019932,
    -434590390, -659539734, -1421027098, 918166899, 908005131,
    -2147312400, 458532522, -991244053, 1218460415, 867480122,
    9715278, -235178626, -1833596690, -485094724, 1681628163,
    -1807050423, 1931930769, -1930745437, 260922032, 1918170082,
    1314612525, 1619339132, 213759303, 395423534, -1286874244,
    -928030820, 1544241865, -2141991414, -415725589, -415037239,
    -1792973446, -1066624791, -999065976, -1970156330,
    -792084777, 99366839, -1443236438, 109395627, -1033087172,
    1636880325, 1797377932, 107611347, -66278571, 1719917235,
    -980532359, -1025016591, 1526896200, -1431512337,
    1523954594, 268217725, -661358465, 357951574, -1204835194,
    -124976602, -1355777195, 227507787, -1959108909,
    -1967656422, -1640953600, -928298170, -1212253517,
    688353681, -183343651, -1502054102, 2109160116, -615318982,
    -1298916831, -276452464, 1569314103, 1516988700,
    -1878461527, -1835444056, 900533028, 1083346540, 1620991935,
    -756070802, 1064638710, 2084121404, 567428782, -989573698,
    1237783027, -29509583, -1913038067, -213837713, 320045600,
    -1575023354, -639784845, -1304869412, 521271513, -841450851,
    504144272, 184536788, 1796532970, -1962763698, 415168201,
    -520461944, 448158373, -1927399360, -943757663, -1736385629,
    1128741147, -297819257, 1144066721, 1202433626, 485987264,
    -71941828, 146605996, -1764659745, 98044363, 1891432219,
    39438797, 849546607, 183467933, -791411486, -2109255332,
    -2089949815, 1235929901, 844849263, 264245041, 1700595120,
    -64904453, 1436463329, -1016299735, 1915725877, 1093668127,
    -417314264, };

  @SuppressWarnings("unused")
  private final double[] subnormals = 
{ 0x0.fffffffffffffp-1022,
  0x0.0000000000001p-1022,
};

  @SuppressWarnings("unused")
  private final double[] nonfinite = 
{ Double.NaN,
  Double.POSITIVE_INFINITY,
  Double.NEGATIVE_INFINITY,
};

  @SuppressWarnings("unused")
  private final double[] numbers0 = 
{ 0x0.0p0, -0x0.0p0, 0x1.0p0, -0x1.0p0, 0x1.0p1, 0x1.8p1, 
  0x1.0p-1, 0x1.0p-2, 0x1.fffffffffffffp1023, 0x1.0p-1022,
  0x0.fffffffffffffp-1022, 0x0.0000000000001p-1022,
  1.0 / Math.E, Math.nextUp(1.0 / Math.E),                                       
};

  private double[] numbers1;
  private double[] numbers2;
  @SuppressWarnings("unused")
  private double[] numbers3;
  @SuppressWarnings("unused")
  private double[] numbers4;

  private static final int N = 1000;

  //--------------------------------------------------------------

  @Before
  public void setUp () {
    assert 1391 == SEED.length;
    final UniformRandomProvider prng = 
      RandomSource.create(RandomSource.WELL_44497_B, SEED);
    numbers1 = PRNG.randomDoublesNonNegative(N,prng);
    numbers2 = PRNG.randomDoubles(N,prng);
    numbers3 = PRNG.randomDoublesMinusMean(N,prng);
    numbers4 = PRNG.randomDoublesZeroSum(N,prng);
  }

  @After
  public void tearDown () { 
    numbers1 = null; 
    numbers2 = null; 
    numbers3 = null; 
    numbers4 = null; }

  //--------------------------------------------------------------

  private static final boolean someNormal (final double[] x) {
    for (int i=0;i<x.length;i++) {
      //System.out.println(Double.toHexString(x[i]));
      if (Doubles.isNormal(x[i])) { return true; } }
    return false; }

  private static final boolean someNegative (final double[] x) {
    for (int i=0;i<x.length;i++) {
      //System.out.println(Double.toHexString(x[i]));
      if (x[i] < 0.0) { return true; } }
    return false; }

  private static final boolean noNegative (final double[] x) {
    for (int i=0;i<x.length;i++) {
      //System.out.println(Double.toHexString(x[i]));
      if (x[i] < 0.0) { return false; } }
    return true; }

  @SuppressWarnings("unused")
  private static final boolean allNormal (final double[] x) {
    for (int i=0;i<x.length;i++) {
      //System.out.println(Double.toHexString(x[i]));
      if (! Doubles.isNormal(x[i])) { return false; } }
    return true; }

  @SuppressWarnings("static-method")
  @Test
  public final void makeDouble () {
    final double x0 = Doubles.makeDouble(0,1024,0L);
    //System.out.println(Double.toHexString(x0));
    Assert.assertTrue(Double.toHexString(x0), x0 == 0x1.0p1);
    Assert.assertEquals(x0,0x1.0p1,0.0);
  }
  @Test
  public final void isNormal () {
    //System.out.println(0);
    //allNormal(numbers0);
    System.out.println(1);
    Assert.assertTrue(someNormal(numbers1));
    //Assert.assertTrue(allNormal(numbers1));
    Assert.assertTrue(noNegative(numbers1));
    System.out.println(2);
    Assert.assertTrue(someNormal(numbers2));
    //Assert.assertTrue(allNormal(numbers2));
    Assert.assertTrue(someNegative(numbers2));

    System.out.println(3);
    allNormal(numbers3);
    System.out.println(4);
    allNormal(numbers4);
    //System.out.println("subnormals");
    //noNormal(subnormals); 
    //System.out.println("nonfinite");
    //noNormal(nonfinite); 
  }

}
